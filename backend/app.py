"""Flask应用主入口文件。

该文件初始化Flask应用，配置CORS、日志、Redis连接等基础设置，并注册路由。
"""

from __future__ import annotations

import logging
from pathlib import Path
import sys
from typing import Any

from flask import Flask, jsonify, request
from flask_cors import CORS
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address
import redis

# 确保脚本运行时能找到 backend 包
PROJECT_ROOT = Path(__file__).resolve().parents[1]
if str(PROJECT_ROOT) not in sys.path:
    sys.path.insert(0, str(PROJECT_ROOT))

from backend.config import Config

# 初始化配置
config = Config()

# 设置日志
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# 初始化Flask应用
app = Flask(__name__)

# 配置应用
# 1. JWT签名密钥
app.config['SECRET_KEY'] = config.auth_jwt_secret or 'dev-secret'  # 用于JWT签名
# 2. JSON响应支持中文
app.config['JSON_AS_ASCII'] = False  # 支持中文

# 配置CORS
# 支持跨域资源共享，允许前端应用从不同域名访问API
CORS(app, origins=config.cors_allow_origins or ['*'])  # 允许所有来源，生产环境应限制具体域名

# 配置API限流
# 使用客户端IP作为唯一标识，防止恶意请求
limiter = Limiter(
    get_remote_address,  # 限流标识：客户端IP
    app=app,             # 绑定到Flask应用
    default_limits=['100 per day', '20 per hour'],  # 默认限流规则
    storage_uri='memory://'  # 限流数据存储在内存中
)

# 初始化Redis连接
# 用于缓存API响应，提升性能并减少数据库压力
redis_client = None
try:
    redis_client = redis.Redis(
        host=config.redis_host,  # Redis服务器地址
        port=config.redis_port,  # Redis端口
        db=config.redis_db,      # Redis数据库
        password=config.redis_password  # Redis密码
    )
    # 测试连接
    redis_client.ping()
    logger.info("成功连接到Redis服务器")
except Exception as e:
    logger.error(f"无法连接到Redis服务器: {e}")
    redis_client = None
    # 注意：Redis连接失败不影响API基本功能，只是缓存功能不可用

# 初始化缓存
# 封装Redis缓存功能，支持304 Not Modified响应
from backend.utils.redis_cache import init_cache, RedisCache
redis_cache = init_cache(redis_client)

# 全局错误处理
@app.errorhandler(400)
def bad_request(error: Any) -> tuple[Any, int]:
    """处理400错误"""
    return jsonify({"error": "请求参数错误"}), 400

@app.errorhandler(401)
def unauthorized(error: Any) -> tuple[Any, int]:
    """处理401错误"""
    return jsonify({"error": "未授权访问"}), 401

@app.errorhandler(403)
def forbidden(error: Any) -> tuple[Any, int]:
    """处理403错误"""
    return jsonify({"error": "禁止访问"}), 403

@app.errorhandler(404)
def not_found(error: Any) -> tuple[Any, int]:
    """处理404错误"""
    return jsonify({"error": "资源不存在"}), 404

@app.errorhandler(500)
def internal_server_error(error: Any) -> tuple[Any, int]:
    """处理500错误"""
    logger.error(f"服务器内部错误: {error}")
    return jsonify({"error": "服务器内部错误"}), 500

# 健康检查端点
@app.route('/api/health', methods=['GET'])
def health_check() -> tuple[Any, int]:
    """健康检查端点"""
    return jsonify({
        "status": "ok",
        "service": "oa-api",
        "version": "0.1.0"
    }), 200

# 导入并注册路由
from backend.routes import articles, auth, ai

app.register_blueprint(auth.bp, url_prefix='/api/auth')
app.register_blueprint(articles.bp, url_prefix='/api/articles')
app.register_blueprint(ai.bp, url_prefix='/api/ai')

if __name__ == '__main__':
    # 开发环境运行
    app.run(host='0.0.0.0', port=4420, debug=True)
