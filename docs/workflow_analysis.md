# OA 系统通知爬取与推送项目工作流程分析（以开发计划为准）

## 一、完整工作流程图（当前主流程）

```
┌─────────────────────┐   ┌─────────────────────┐   ┌─────────────────────┐
│ 调度器/入口 (main)   │──►│ 获取当日列表         │──►│ 去重筛选新增条目     │
│ 07:00-24:00 每小时   │   │ crawler/fetcher      │   │ 基于 link            │
└─────────────────────┘   └─────────────────────┘   └─────────────────────┘
                                      │                         │
                                      ▼                         │
┌─────────────────────┐   ┌─────────────────────┐   ┌─────────────────────┐
│ 解析详情与附件元数据 │──►│ 生成 AI 摘要(重试)   │──►│ 写入文章表           │
│ crawler/fetcher      │   │ crawler/summarizer  │   │ crawler/storage      │
└─────────────────────┘   └─────────────────────┘   └─────────────────────┘
                                      │                         │
                                      ▼                         │
┌─────────────────────┐   ┌─────────────────────┐   ┌─────────────────────┐
│ 生成当日向量         │──►│ 更新缓存/索引        │──►│ 后端 API 提供查询    │
│ crawler/embeddings   │   │ Redis/pgvector       │   │ Flask + Postgres     │
└─────────────────────┘   └─────────────────────┘   └─────────────────────┘
                                                                │
                                                                ▼
                                                      ┌─────────────────────┐
                                                      │ APP 轮询/通知       │
                                                      │ Expo RN             │
                                                      └─────────────────────┘
```

## 二、详细工作流程说明

### 1. 爬虫模块工作流程

1. **触发与初始化**
   - 通过 `main.py` 触发爬虫执行
   - 支持命令行参数 `--date` 指定爬取日期
   - 默认使用当前日期（仅 07:00-24:00 运行）

2. **文章列表获取**
   - 获取指定日期的文章列表
   - 解析文章元数据（标题、发布单位、链接、发布日期）

3. **增量爬取与去重**
   - 查询数据库获取已存在的文章链接
   - 过滤出新增文章（不在已存在链接集合中）

4. **文章详情获取与附件解析**
   - 获取正文内容
   - 解析附件名称与 URL，仅记录元数据，不下载文件

5. **AI 摘要生成**
   - 对新增文章批量调用 AI 摘要
   - 失败统一重试，最多 3 轮
   - 仍失败写占位摘要并记日志

6. **数据存储与向量**
   - 写入文章表
   - 生成当日向量写入向量表（仅供当日问答）

### 2. 后端 API 工作流程（规划）

1. **认证**
   - SSO 登录换取 JWT
   - 支持刷新令牌

2. **文章增量接口**
   - `/articles?date=YYYY-MM-DD&since=ts` 提供增量查询
   - 支持 ETag/Last-Modified 返回 304

3. **AI 问答**
   - 官方模式 `/ai/ask` 仅检索当日向量
   - 代理模式 `/ai/ask/proxy` 透传用户模型参数

### 3. APP 端工作流程（规划）

1. **鉴权与缓存**
   - SSO 登录获取 JWT
   - react-query 持久化缓存，离线可读

2. **轮询与通知**
   - 每小时轮询增量接口
   - 发现新文章触发本地通知与角标

3. **阅读状态同步**
   - 阅读时调用 `/articles/read` 同步已读

## 三、旧模块说明

- `sender/` 为历史邮件发送模块，**主流程已移除**，仅作为旧逻辑参考。

## 四、项目状态总结（对齐开发计划）

### 已完成的核心功能
1. ✅ 爬虫模块（增量爬取、AI 摘要、向量生成）

### 进行中 / 待实现的关键功能
1. ⏳ 后端 API（认证、文章增量、问答、缓存、限流）
2. ⏳ APP 客户端（轮询、通知、阅读状态）
3. ⏳ 调度与监控系统（成功率、延迟、调用量）

## 五、下一步建议（规划）

1. **补齐后端 API**：以开发计划的接口为准实现
2. **接入调度与监控**：保证按时运行与可观测性
3. **APP 联调**：打通增量拉取、通知、问答链路
