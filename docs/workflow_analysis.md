# OA系统通知爬取与推送项目工作流程分析

## 一、完整工作流程图

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   触发爬虫      │     │   获取文章列表  │     │   过滤新增文章  │
│  (main.py)      │────►│  (crawler/fetcher.py) │   (基于链接去重) │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                               │                       ▲
                               ▼                       │
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   检查运行时段  │     │   获取文章详情  │     │   查询已有链接  │
│  (07:00-24:00)  │     │  (crawler/fetcher.py) │   (storage.py)   │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                               │                       ▲
                               ▼                       │
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   生成AI摘要    │     │   插入文章数据  │     │   初始化数据库  │
│ (crawler/summarizer.py)│   (storage.py)   │   (db.py)        │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                               │                       ▲
                               ▼                       │
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   生成向量      │     │   保存通知JSON  │     │   定位目标文件  │
│ (crawler/embeddings.py)│   (sender模块)    │   (sender/Sender.py) │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                               │                       ▲
                               ▼                       │
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   发送邮件通知  │     │   生成HTML内容  │     │   获取收件人列表│
│ (sender/Sender.py)│   (sender/Sender.py) │   (sender/Sender.py) │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

## 二、详细工作流程说明

### 1. 爬虫模块工作流程

1. **触发与初始化**
   - 通过 `main.py` 触发爬虫执行
   - 支持命令行参数 `--date` 指定爬取日期
   - 默认使用当前日期（当天仅07:00-24:00运行）

2. **文章列表获取**
   - 调用 `fetcher.py` 中的 `fetch_list` 方法
   - 从 OA 系统获取指定日期的文章列表
   - 解析文章元数据（标题、发布单位、链接、发布日期）

3. **增量爬取与去重**
   - 查询数据库获取已存在的文章链接
   - 过滤出新增文章（不在已存在链接集合中）

4. **文章详情获取**
   - 为新增文章获取详细内容
   - 解析文章正文和附件信息
   - 清理和格式化 HTML 内容

5. **AI 摘要生成**
   - 调用 AI 模型生成文章摘要
   - 实现重试机制（最多3次）
   - 为失败的文章添加默认摘要

6. **数据存储**
   - 将文章数据插入数据库
   - 为文章生成向量
   - 保存向量到数据库

### 2. 邮件发送模块工作流程

1. **文件定位**
   - 按照优先级策略定位目标通知文件
   - 支持指定日期、前一天或最新文件

2. **收件人管理**
   - 从配置文件读取收件人邮箱列表
   - 过滤出有效的邮箱地址

3. **邮件内容生成**
   - 读取通知 JSON 文件内容
   - 生成响应式 HTML 格式邮件
   - 使用 CSS 美化邮件布局

4. **邮件发送**
   - 配置 SMTP 服务器信息
   - 为每个收件人发送邮件
   - 记录发送结果和异常信息

## 三、未实现的功能

### 1. 后端 API（Flask + Postgres + Redis）
- ✅ 用户认证系统（SSO 交换 JWT）
- ✅ 文章 API 端点（增量列表、详情、阅读状态）
- ✅ AI 问答 API（基于向量的问答）
- ✅ Redis 缓存集成（支持 304 Not Modified）
- ✅ HTTPS 和 CORS 支持
- ✅ API 限流和日志系统

### 2. 监控与调度
- [ ] 定时调度器（目前需要手动运行）
- [ ] 监控指标收集（爬虫成功率、接口延迟等）
- [ ] 结构化日志系统

### 3. 移动应用（Expo React Native）
- [ ] SSO 登录功能
- [ ] 文章列表和详情展示
- [ ] 本地通知和后台轮询
- [ ] 阅读状态同步
- [ ] 离线缓存支持

### 4. 高级功能
- [ ] AI 问答功能（基于当日向量）
- [ ] 附件下载功能
- [ ] 用户偏好设置
- [ ] 多设备同步

## 四、项目状态总结

### 已完成的核心功能
1. ✅ 爬虫模块（增量爬取、AI摘要、向量生成）
2. ✅ 邮件发送模块（HTML生成、SMTP发送）
3. ✅ 配置管理（环境变量、配置文件）
4. ✅ 数据模型和数据库操作
5. ✅ 完整的后端 API 服务

### 待实现的关键功能
1. ❌ 定时调度和监控系统
2. ❌ 移动应用客户端
3. ❌ AI 问答功能

## 五、下一步建议

1. **优先集成定时调度**：实现自动化运行
2. **开发监控系统**：确保系统稳定运行
3. **构建移动应用**：提供用户友好的访问界面
4. **完善 AI 功能**：增强用户体验

## 六、技术债务与改进点

1. **代码结构优化**：部分模块耦合度较高
2. **错误处理增强**：增加更多异常情况处理
3. **测试覆盖提升**：添加单元测试和集成测试
4. **文档完善**：补充API文档和部署指南
5. **性能优化**：改进数据库查询和网络请求效率
